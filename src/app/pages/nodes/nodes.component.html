<section class="space-y-6">
  <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
    <div class="space-y-2">
      <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Nodos y roles</h1>
      <p class="text-sm text-gray-500 dark:text-gray-400">
        Estado operacional del consorcio PnV: bookkeepers activos, comisión votante y candidatos en espera.
      </p>
    </div>
    <div class="flex flex-wrap items-center gap-3">
      <div class="rounded-lg border border-gray-200 px-4 py-2 text-xs text-gray-500 dark:border-gray-700 dark:text-gray-400">
        Última actualización {{ formatTimestamp(dashboardState()?.system?.updated_at ?? null) }}
      </div>
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-4 py-2 text-sm font-medium text-gray-700 transition hover:border-brand-500 hover:text-brand-600 dark:border-gray-700 dark:text-gray-200 dark:hover:border-brand-400"
        (click)="refresh()"
      >
        <span class="inline-flex h-2 w-2 rounded-full bg-emerald-500"></span>
        Actualizar
      </button>
    </div>
  </header>

  @if (loadError()) {
    <div class="rounded-lg border border-rose-400 bg-rose-500/10 px-4 py-3 text-sm text-rose-200">
      {{ loadError() }}
    </div>
  }

  <div class="grid gap-3 md:grid-cols-5">
    <article class="rounded-xl border border-gray-100 bg-white/80 p-4 shadow-sm dark:border-gray-800 dark:bg-gray-900">
      <h3 class="text-xs uppercase tracking-wide text-gray-400 dark:text-gray-500">Bookkeepers</h3>
      <p class="mt-2 text-2xl font-semibold text-gray-900 dark:text-white">{{ summary().totalButlers }}</p>
    </article>
    <article class="rounded-xl border border-gray-100 bg-white/80 p-4 shadow-sm dark:border-gray-800 dark:bg-gray-900">
      <h3 class="text-xs uppercase tracking-wide text-gray-400 dark:text-gray-500">Activos</h3>
      <p class="mt-2 text-2xl font-semibold text-emerald-500 dark:text-emerald-300">{{ summary().activeButlers }}</p>
    </article>
    <article class="rounded-xl border border-gray-100 bg-white/80 p-4 shadow-sm dark:border-gray-800 dark:bg-gray-900">
      <h3 class="text-xs uppercase tracking-wide text-gray-400 dark:text-gray-500">Commissioners online</h3>
      <p class="mt-2 text-2xl font-semibold text-blue-500 dark:text-blue-300">{{ summary().onlineCommissioners }}</p>
    </article>
    <article class="rounded-xl border border-gray-100 bg-white/80 p-4 shadow-sm dark:border-gray-800 dark:bg-gray-900">
      <h3 class="text-xs uppercase tracking-wide text-gray-400 dark:text-gray-500">Commissioners totales</h3>
      <p class="mt-2 text-2xl font-semibold text-gray-900 dark:text-white">{{ summary().totalCommissioners }}</p>
    </article>
    <article class="rounded-xl border border-gray-100 bg-white/80 p-4 shadow-sm dark:border-gray-800 dark:bg-gray-900">
      <h3 class="text-xs uppercase tracking-wide text-gray-400 dark:text-gray-500">Candidatos</h3>
      <p class="mt-2 text-2xl font-semibold text-amber-500 dark:text-amber-300">{{ summary().totalCandidates }}</p>
    </article>
  </div>

  <div class="grid gap-6 lg:grid-cols-2">
    <section class="space-y-4 rounded-2xl border border-gray-100 bg-white/80 p-5 shadow-sm dark:border-gray-800 dark:bg-gray-900">
      <header class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Bookkeepers activos</h2>
          <p class="text-xs text-gray-500 dark:text-gray-400">
            Slots electos para producción de bloques y custodia del ledger.
          </p>
        </div>
        <div class="rounded-full border border-gray-200 px-3 py-1 text-xs text-gray-500 dark:border-gray-700 dark:text-gray-400">
          Slot actual: {{ dashboardState()?.system?.current_butler_slot ?? '—' }}
        </div>
      </header>

      @if (butlers().length === 0) {
        <div class="rounded-lg border border-dashed border-gray-200 bg-white/50 p-6 text-center text-sm text-gray-500 dark:border-gray-700 dark:bg-gray-900/60 dark:text-gray-400">
          No hay bookkeepers registrados.
        </div>
      } @else {
        <div class="grid gap-3 md:grid-cols-2">
          @for (butler of butlers(); track butler.slot) {
            <article class="rounded-xl border border-gray-200 bg-gray-50 p-4 transition hover:border-brand-200 dark:border-gray-700 dark:bg-gray-800/60">
              <header class="flex items-start justify-between gap-3">
                <div>
                  <h3 class="text-sm font-semibold text-gray-900 dark:text-white">{{ butler.name }}</h3>
                  <p class="text-xs text-gray-500 dark:text-gray-400">Slot {{ butler.slot }}</p>
                </div>
                @if (butler.isCurrent) {
                  <span class="rounded-full bg-emerald-500/10 px-3 py-1 text-[10px] font-semibold text-emerald-600 dark:bg-emerald-500/20 dark:text-emerald-300">
                    Lider actual
                  </span>
                }
              </header>

              <dl class="mt-3 grid grid-cols-2 gap-3 text-xs text-gray-600 dark:text-gray-300">
                <div>
                  <dt class="text-gray-400 dark:text-gray-500">Stake</dt>
                  <dd class="font-semibold text-gray-900 dark:text-white">{{ formatNumber(butler.stake) }} PNV</dd>
                </div>
                <div>
                  <dt class="text-gray-400 dark:text-gray-500">Score</dt>
                  <dd>
                    <span class="inline-flex items-center rounded-full px-2 py-1 text-[11px] font-semibold" [ngClass]="scoreBadgeClass(butler.score)">
                      {{ butler.score }} pts
                    </span>
                  </dd>
                </div>
                <div>
                  <dt class="text-gray-400 dark:text-gray-500">Bloques producidos</dt>
                  <dd>{{ formatNumber(butler.blocksProduced) }}</dd>
                </div>
                <div>
                  <dt class="text-gray-400 dark:text-gray-500">Último latido</dt>
                  <dd>{{ formatTimestamp(butler.lastSeen) }}</dd>
                </div>
              </dl>
            </article>
          }
        </div>
      }
    </section>

    <section class="space-y-4 rounded-2xl border border-gray-100 bg-white/80 p-5 shadow-sm dark:border-gray-800 dark:bg-gray-900">
      <header class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Commissioners</h2>
          <p class="text-xs text-gray-500 dark:text-gray-400">Entidades que firman y validan cada bloque.</p>
        </div>
        <div class="rounded-full border border-gray-200 px-3 py-1 text-xs text-gray-500 dark:border-gray-700 dark:text-gray-400">
          Mayoría necesaria: {{ majorityThreshold() }}
        </div>
      </header>

      @if (commissioners().length === 0) {
        <div class="rounded-lg border border-dashed border-gray-200 bg-white/50 p-6 text-center text-sm text-gray-500 dark:border-gray-700 dark:bg-gray-900/60 dark:text-gray-400">
          No hay commissioners registrados.
        </div>
      } @else {
        <div class="space-y-3">
          @for (comm of commissioners(); track comm.id) {
            <article class="flex items-center justify-between gap-3 rounded-lg border border-gray-200 bg-gray-50 p-3 dark:border-gray-700 dark:bg-gray-800/60">
              <div>
                <h3 class="text-sm font-semibold text-gray-900 dark:text-white">{{ comm.name }}</h3>
                <p class="text-xs text-gray-500 dark:text-gray-400">{{ comm.region ?? 'Región desconocida' }}</p>
              </div>
              <div class="flex items-center gap-2 text-xs">
                <span class="rounded-full px-2 py-1" [ngClass]="commissionerStatusClass(comm.online)">
                  {{ comm.online ? 'Online' : 'Offline' }}
                </span>
                <span class="rounded-full bg-gray-100 px-2 py-1 text-gray-500 dark:bg-gray-700 dark:text-gray-300">
                  Peso {{ comm.voteWeight }}
                </span>
              </div>
            </article>
          }
        </div>
      }
    </section>
  </div>

  <section class="space-y-3 rounded-2xl border border-gray-100 bg-white/80 p-5 shadow-sm dark:border-gray-800 dark:bg-gray-900">
    <header class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Candidatos a butler</h2>
        <p class="text-xs text-gray-500 dark:text-gray-400">Postulantes en espera para ocupar slots libres.</p>
      </div>
      <div class="rounded-full border border-gray-200 px-3 py-1 text-xs text-gray-500 dark:border-gray-700 dark:text-gray-400">
        Total candidatos: {{ summary().totalCandidates }}
      </div>
    </header>

    @if (candidates().length === 0) {
      <div class="rounded-lg border border-dashed border-gray-200 bg-white/50 p-6 text-center text-sm text-gray-500 dark:border-gray-700 dark:bg-gray-900/60 dark:text-gray-400">
        No hay candidatos registrados.
      </div>
    } @else {
      <div class="grid gap-3 md:grid-cols-2 lg:grid-cols-3">
        @for (candidate of candidates(); track candidate.id) {
          <article class="rounded-xl border border-gray-200 bg-gray-50 p-4 dark:border-gray-700 dark:bg-gray-800/60">
            <header class="flex items-center justify-between">
              <h3 class="text-sm font-semibold text-gray-900 dark:text-white">{{ candidate.name }}</h3>
              @if (candidate.recommended) {
                <span class="rounded-full bg-brand-500/10 px-2 py-1 text-[10px] font-semibold text-brand-600 dark:bg-brand-500/20 dark:text-brand-300">
                  Recomendado
                </span>
              }
            </header>
            <dl class="mt-3 grid grid-cols-2 gap-3 text-xs text-gray-600 dark:text-gray-300">
              <div>
                <dt class="text-gray-400 dark:text-gray-500">Stake</dt>
                <dd class="font-semibold text-gray-900 dark:text-white">{{ formatNumber(candidate.stake) }} PNV</dd>
              </div>
              <div>
                <dt class="text-gray-400 dark:text-gray-500">Score</dt>
                <dd>
                  <span class="inline-flex items-center rounded-full px-2 py-1 text-[11px] font-semibold" [ngClass]="scoreBadgeClass(candidate.score)">
                    {{ candidate.score }} pts
                  </span>
                </dd>
              </div>
              <div class="col-span-2">
                <dt class="text-gray-400 dark:text-gray-500">Alta</dt>
                <dd>{{ formatTimestamp(candidate.createdAt) }}</dd>
              </div>
            </dl>
          </article>
        }
      </div>
    }
  </section>
</section>

